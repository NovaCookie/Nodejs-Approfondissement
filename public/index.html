<!DOCTYPE html>
<html>
  <head>
    <title>Gestion Utilisateurs</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.27.2/axios.min.js"></script>
    <script src="https://unpkg.com/vue@3"></script>
  </head>
  <body>
    <main class="container" id="app">
      <article class="grid" v-if="layout === 'login'">
        <div>
          <hgroup>
            <h1>Connexion</h1>
            <h2>Connectez-vous pour gérer les utilisateurs</h2>
          </hgroup>
          <form @submit.prevent="login">
            <input
              type="email"
              placeholder="Email"
              aria-label="Email"
              required
              v-model="email"
            />
            <input
              type="password"
              placeholder="Password"
              aria-label="Password"
              required
              v-model="password"
            />
            <button type="submit" class="contrast">Se connecter</button>
          </form>
          <p><small>Test: admin@example.com / admin123</small></p>
        </div>
      </article>

      <article v-else>
        <nav>
          <ul>
            <li><strong>Admin Panel</strong></li>
          </ul>
          <ul>
            <li>
              <button @click="logout" class="secondary">Déconnexion</button>
            </li>
          </ul>
        </nav>

        <h1>Créer un utilisateur</h1>
        <form @submit.prevent="create">
          <input
            type="text"
            placeholder="Nom"
            required
            v-model="newUser.name"
          />
          <input
            type="email"
            placeholder="Email"
            required
            v-model="newUser.email"
          />
          <input
            type="password"
            placeholder="Password"
            required
            v-model="newUser.password"
          />
          <select v-model="newUser.role">
            <option value="member">Membre</option>
            <option value="admin">Administrateur</option>
          </select>
          <button type="submit" class="contrast">Créer l'utilisateur</button>
        </form>

        <h1>Utilisateurs existants ({{ users.length }})</h1>
        <table v-if="users.length > 0">
          <thead>
            <tr>
              <th scope="col">Nom</th>
              <th scope="col">Email</th>
              <th scope="col">Rôle</th>
              <th scope="col">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="user in users" :key="user._id">
              <td>{{ user.name }}</td>
              <td>{{ user.email }}</td>
              <td><mark :class="user.role">{{ user.role }}</mark></td>
              <td>
                <button @click="remove(user._id)" class="secondary">
                  Supprimer
                </button>
              </td>
            </tr>
          </tbody>
        </table>
        <p v-else>Aucun utilisateur trouvé.</p>
      </article>
    </main>

    <script>
      const { createApp } = Vue;
      const socket = io();

      createApp({
        data() {
          return {
            layout: "login",
            email: "",
            password: "",
            users: [],
            newUser: {
              name: "",
              email: "",
              password: "",
              role: "member",
            },
            userToken: "",
          };
        },
        mounted() {
          this.load();
        },
        methods: {
          async login() {
            try {
              const response = await axios.post("/login", {
                email: this.email,
                password: this.password,
              });

              if (response.data.token) {
                this.userToken = response.data.token;
                localStorage.setItem("token", this.userToken);
                await this.loadUsers();
                this.layout = "list";
              }
            } catch (error) {
              console.error("Login error:", error);
              alert("Erreur de connexion");
            }
          },

          async load() {
            this.userToken = localStorage.getItem("token");
            if (this.userToken) {
              await this.loadUsers();
              this.layout = "list";
            }
          },

          async loadUsers() {
            try {
              const response = await axios.get("/api/users", {
                headers: {
                  "x-access-token": this.userToken,
                },
              });
              this.users = response.data;
            } catch (error) {
              console.error("Error loading users:", error);
              if (error.response?.status === 401) {
                this.logout();
              }
            }
          },

          async remove(userId) {
            if (
              confirm("Êtes-vous sûr de vouloir supprimer cet utilisateur ?")
            ) {
              try {
                await axios.delete("/api/users/" + userId, {
                  headers: {
                    "x-access-token": this.userToken,
                  },
                });
                // Recharger la liste
                await this.loadUsers();
              } catch (error) {
                console.error("Delete error:", error);
                alert("Erreur lors de la suppression");
              }
            }
          },

          async create() {
            try {
              await axios.post("/api/users", this.newUser, {
                headers: {
                  "x-access-token": this.userToken,
                },
              });

              // Réinitialiser le formulaire
              this.newUser = {
                name: "",
                email: "",
                password: "",
                role: "member",
              };

              // Recharger la liste
              await this.loadUsers();
            } catch (error) {
              console.error("Create error:", error);
              alert("Erreur lors de la création");
            }
          },

          logout() {
            localStorage.removeItem("token");
            this.userToken = "";
            this.layout = "login";
            this.email = "";
            this.password = "";
          },
        },
      }).mount("#app");
    </script>

    <style>
      mark.member {
        background: #d4edda;
        color: #155724;
      }
      mark.admin {
        background: #f8d7da;
        color: #721c24;
      }
      .container {
        max-width: 1200px;
      }
      table {
        margin-top: 1rem;
      }
      form {
        margin-bottom: 2rem;
      }
    </style>
  </body>
</html>
